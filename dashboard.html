<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gojo Six Eyes | Admin Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #050505; color: #00d9ff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { letter-spacing: 5px; text-transform: uppercase; text-shadow: 0 0 10px rgba(0, 217, 255, 0.5); }
        
        /* Stats Panel */
        .admin-stats { display: flex; gap: 20px; margin-bottom: 20px; width: 100%; max-width: 900px; }
        .stat-card { background: #0a0a0a; border: 1px solid #111; padding: 15px; border-radius: 8px; flex: 1; text-align: center; }
        .stat-card h2 { margin: 0; font-size: 1.5rem; }
        .stat-card p { margin: 5px 0 0; color: #555; font-size: 0.8rem; }

        .search-section { background: #0a0a0a; padding: 20px; border-radius: 8px; border: 1px solid #111; display: flex; gap: 10px; margin-bottom: 20px; width: 100%; max-width: 900px; justify-content: center; }
        input { background: #000; border: 1px solid #00d9ff; color: white; padding: 12px; border-radius: 4px; outline: none; width: 250px; }
        button { background: #00d9ff; color: black; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-export { background: #28a745; color: white; }
        .btn-delete { background: #ff4444; color: white; }

        .results-container { width: 100%; max-width: 900px; }
        .log-card { background: #0a0a0a; border: 1px solid #111; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.85rem; }
        .label { color: #555; font-size: 0.7rem; text-transform: uppercase; }
        .timestamp { color: #00d9ff; font-size: 0.7rem; text-align: right; grid-column: span 3; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ðŸŒ€ ADMIN CONTROL CENTER</h1>
    </div>

    <div class="admin-stats">
        <div class="stat-card">
            <h2 id="total-logs">0</h2>
            <p>TOTAL TELEMETRY</p>
        </div>
        <div class="stat-card">
            <h2 id="last-ip">---</h2>
            <p>LAST CAPTURED IP</p>
        </div>
    </div>

    <div class="search-section">
        <input type="text" id="op-input" placeholder="Search ID (Case Sensitive)">
        <button onclick="searchLogs()">DECODE</button>
    </div>

    <div class="controls">
        <button class="btn-export" onclick="exportToCSV()">ðŸ’¾ EXCEL (CSV)</button>
        <button class="btn-delete" onclick="clearLogs()">ðŸ”¥ PURGE ID</button>
    </div>

    <div class="results-container" id="results-area">
        <p style="text-align:center; color:#444;">Standby for data input...</p>
    </div>

    <script>
        const SUPABASE_URL = 'https://kisbfmcxvcwtxfwbgexb.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_THarexbaf5WB2Cc-c6t-sg_TQJycbtz';
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentData = [];

        // Sahifa yuklanganda umumiy statistika va oxirgi loglarni chiqarish
        async function fetchStats() {
            const { data, count } = await _supabase
                .from('telemetry')
                .select('*', { count: 'exact' })
                .order('created_at', { ascending: false })
                .limit(5);

            if (data) {
                document.getElementById('total-logs').innerText = count;
                document.getElementById('last-ip').innerText = data[0]?.ip || "None";
                renderLogs(data, "LATEST LIVE LOGS");
                currentData = data;
            }
        }

        async function searchLogs() {
            const opID = document.getElementById('op-input').value.trim();
            if (!opID) return alert("Enter ID!");

            const { data, error } = await _supabase
                .from('telemetry')
                .select('*')
                .eq('operation_id', opID) // Case sensitive qidiruv
                .order('created_at', { ascending: false });

            if (data) {
                currentData = data;
                renderLogs(data, `RESULTS FOR: ${opID}`);
            }
        }

        function renderLogs(logs, title) {
            const area = document.getElementById('results-area');
            area.innerHTML = `<h3 style="margin-bottom:15px; font-size:0.9rem;">${title}</h3>`;
            logs.forEach(log => {
                area.innerHTML += `
                    <div class="log-card">
                        <div><div class="label">ID</div><div>${log.operation_id}</div></div>
                        <div><div class="label">IP</div><div>${log.ip}</div></div>
                        <div><div class="label">Location</div><div>${log.location}</div></div>
                        <div class="timestamp">${new Date(log.created_at).toLocaleString()}</div>
                    </div>`;
            });
        }

        function exportToCSV() {
            if (currentData.length === 0) return alert("No data to export!");
            let csv = "ID,IP,Location,Time\n";
            currentData.forEach(row => {
                csv += `${row.operation_id},${row.ip},${row.location},${row.created_at}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'six_eyes_logs.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function clearLogs() {
            const opID = document.getElementById('op-input').value.trim();
            if (!opID || !confirm(`Delete all logs for ${opID}?`)) return;
            await _supabase.from('telemetry').delete().eq('operation_id', opID);
            fetchStats();
        }

        window.onload = fetchStats;
    </script>
</body>
</html>
