<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>SIX EYES | TACTICAL v12.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --neon: #00d9ff; --bg: #020202; --panel: #0a0a0c; --java: #00ff41; --danger: #ff003c; --warn: #ffcc00; }
        body { background: var(--bg); color: var(--neon); font-family: 'JetBrains Mono', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        body.stealth-active { filter: brightness(0.6) grayscale(1); }
        body.stealth-active .card:not(.is-threat) { opacity: 0.2; }

        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid #1a1a1a; padding: 15px; display: flex; flex-direction: column; z-index: 10; }
        .main { flex: 1; padding: 20px; overflow-y: auto; background: radial-gradient(circle at center, #050505 0%, #000 100%); }
        
        .visuals-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-bottom: 20px; height: 280px; }
        #map { background: #000; border: 1px solid #222; border-radius: 4px; }
        .chart-container { background: var(--panel); border: 1px solid #222; padding: 10px; position: relative; display: flex; flex-direction: column; justify-content: space-around; }

        .blacklist-area { background: #000; border: 1px solid var(--danger); padding: 10px; font-size: 11px; margin-top: 10px; height: 80px; overflow-y: auto; color: var(--danger); }
        
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .card { background: var(--panel); border: 1px solid #1a1a1a; padding: 15px; border-left: 3px solid var(--neon); position: relative; transition: 0.3s; }
        
        .is-threat { border-left-color: var(--danger) !important; background: linear-gradient(90deg, #1a0000 0%, #0a0a0c 100%); }

        .badge { font-size: 9px; padding: 2px 6px; border-radius: 3px; margin-right: 5px; font-weight: bold; }
        .bg-danger { background: var(--danger); color: #fff; }
        .bg-warn { background: var(--warn); color: #000; }

        .btn { background: none; border: 1px solid var(--neon); color: var(--neon); padding: 8px; cursor: pointer; width: 100%; margin-top: 5px; font-size: 11px; font-family: inherit; }
        .btn-export { border-color: var(--java); color: var(--java); }
        .btn-export:hover { background: var(--java); color: #000; }
        
        #terminal { font-size:9px; color:var(--java); margin-top:10px; height:100px; overflow-y:auto; background: #000; padding: 5px; border: 1px solid #111; }
        
        .investigator-panel { font-size: 10px; color: #666; background: #000; padding: 5px; margin-top: 8px; border: 1px dashed #333; line-height: 1.4; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color:#fff; margin:0;">üåÄ SIX EYES v12</h2>
        <p style="font-size: 10px; color:#444; margin-bottom:15px;">TACTICAL INTELLIGENCE</p>
        
        <button id="stealthBtn" class="btn" onclick="toggleStealth()">STEALTH MODE: OFF</button>
        <button class="btn btn-export" onclick="exportToCSV()">üìÇ EXPORT LOGS (CSV)</button>

        <div id="blacklist" class="blacklist-area"></div>

        <div class="chart-container" style="height: 120px; margin-top: 15px; padding: 5px;">
             <canvas id="trafficChart"></canvas>
        </div>

        <button class="btn" style="margin-top: 15px;" onclick="sync()">SYSTEM REFRESH</button>
        <div id="terminal"></div>
    </aside>

    <main class="main">
        <div class="visuals-grid">
            <div id="map"></div>
            <div class="chart-container">
                <div style="text-align: center;">
                    <label style="font-size: 10px; color: #555;">SYSTEM INTEGRITY</label>
                    <div id="integrity-stat" style="font-size: 45px; font-weight: bold;">100%</div>
                </div>
                <div style="font-size: 11px; border-top: 1px solid #222; pt: 10px;">
                    <div style="display:flex; justify-content:space-between;"><span>BOTS:</span> <span id="stat-bots" style="color:var(--danger)">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>HUMANS:</span> <span id="stat-humans" style="color:var(--java)">0</span></div>
                </div>
            </div>
        </div>

        <div class="data-grid" id="display"></div>
    </main>

    <script>
        const _supabase = window.supabase.createClient('https://kisbfmcxvcwtxfwbgexb.supabase.co', 'sb_publishable_THarexbaf5WB2Cc-c6t-sg_TQJycbtz');

        let map, trafficChart, isStealth = false;
        let BANNED_IPS = JSON.parse(localStorage.getItem('banned_ips')) || [];
        let markers = [];

        function sanitize(str) { return str ? str.replace(/[<>'"/;()]/g, "‚ö†Ô∏è") : ""; }

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        function initChart() {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            trafficChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#00d9ff', borderWidth: 1, pointRadius: 0, fill: true, backgroundColor: 'rgba(0, 217, 255, 0.05)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { display: false } }, plugins: { legend: { display: false } } }
            });
        }

        // üõ∞Ô∏è IP Geolocation Mapper
        function updateMap(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            data.slice(0, 40).forEach(n => {
                let lat = 20, lng = 0;
                // Joylashuv nomiga qarab taxminiy koordinatalar
                if(n.location.includes("Ireland")) { lat = 53.3; lng = -6.2; }
                else if(n.location.includes("United States")) { lat = 37.0; lng = -95.7; }
                else if(n.location.includes("Uzbekistan")) { lat = 41.3; lng = 69.2; }
                else if(n.location.includes("Germany")) { lat = 51.1; lng = 10.4; }
                
                const m = L.circleMarker([lat + (Math.random()*2), lng + (Math.random()*2)], {
                    radius: 4, color: n.user_agent.includes('bot') ? '#ff003c' : '#00ff41', fillOpacity: 0.6
                }).addTo(map);
                markers.push(m);
            });
        }

        // üìÇ SQL History & CSV Export
        function exportToCSV() {
            _supabase.from('telemetry').select('*').then(({data}) => {
                const head = "ID,IP,Location,Time,UserAgent\n";
                const rows = data.map(n => `${n.id},${n.ip},"${n.location}",${n.created_at},"${n.user_agent.replace(/"/g,"'")}"`).join("\n");
                const blob = new Blob([head + rows], {type: 'text/csv'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `threat_report_${Date.now()}.csv`;
                a.click();
                log("Report exported to CSV.");
            });
        }

        function toggleStealth() {
            isStealth = !isStealth;
            document.body.classList.toggle('stealth-active');
            document.getElementById('stealthBtn').innerText = isStealth ? "STEALTH MODE: ON" : "STEALTH MODE: OFF";
        }

        async function sync() {
            const { data } = await _supabase.from('telemetry').select('*').order('created_at', { ascending: false });
            if (data) {
                render(data);
                updateMap(data);
                updateStats(data);
            }
        }

        function updateStats(data) {
            const botCount = data.filter(n => n.user_agent.toLowerCase().includes('bot') || n.user_agent.length < 25).length;
            document.getElementById('stat-bots').innerText = botCount;
            document.getElementById('stat-humans').innerText = data.length - botCount;
            
            const integrity = Math.round(((data.length - botCount) / data.length) * 100);
            document.getElementById('integrity-stat').innerText = integrity + "%";
            
            trafficChart.data.labels = data.slice(0,10).map(n => "");
            trafficChart.data.datasets[0].data = data.slice(0,10).map((_,i) => Math.random()*10);
            trafficChart.update();
        }

        function toggleBan(ip) {
            BANNED_IPS = BANNED_IPS.includes(ip) ? BANNED_IPS.filter(i => i !== ip) : [...BANNED_IPS, ip];
            localStorage.setItem('banned_ips', JSON.stringify(BANNED_IPS));
            document.getElementById('blacklist').innerHTML = BANNED_IPS.map(i => `<div>üö´ ${i} <span style="float:right;cursor:pointer" onclick="toggleBan('${i}')">X</span></div>`).join('');
            sync();
        }

        function render(nodes) {
            const d = document.getElementById('display');
            d.innerHTML = '';
            nodes.forEach(n => {
                const isBanned = BANNED_IPS.includes(n.ip);
                const ua = n.user_agent.toLowerCase();
                const isBot = ua.includes('bot') || ua.includes('crawler') || ua.length < 25;
                const isThreat = isBanned || isBot;

                // üõ°Ô∏è User-Agent Investigator Logic
                let device = "Unknown Device";
                if(ua.includes('windows')) device = "Windows PC";
                if(ua.includes('android')) device = "Android Device";
                if(ua.includes('iphone')) device = "Apple iPhone";
                if(isBot) device = "Automated Bot/Scanner";

                d.innerHTML += `
                    <div class="card ${isThreat ? 'is-threat' : ''}">
                        <div style="margin-bottom: 5px;">
                            ${isBanned ? '<span class="badge bg-danger">BANNED</span>' : ''}
                            ${isBot ? '<span class="badge bg-warn">BOT DETECTED</span>' : ''}
                        </div>
                        <div style="font-weight:bold; font-size:15px; color:#fff;">${sanitize(n.ip)}</div>
                        <div style="font-size:11px; color:var(--neon); margin: 3px 0;">üìç ${sanitize(n.location)}</div>
                        
                        <div class="investigator-panel">
                            <strong>INVESTIGATOR REPORT:</strong><br>
                            Type: ${device}<br>
                            OS Integrity: ${isBot ? '‚ö†Ô∏è SUSPICIOUS' : '‚úÖ VERIFIED'}<br>
                            Full ID: ${ua.substring(0, 50)}...
                        </div>

                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button class="btn" style="flex:1" onclick="window.open('https://abuseipdb.com/check/${n.ip}')">WHOIS</button>
                            <button class="btn btn-danger" style="flex:1" onclick="toggleBan('${n.ip}')">${isBanned?'UNBAN':'BAN'}</button>
                        </div>
                    </div>`;
            });
        }

        function log(msg) {
            const t = document.getElementById('terminal');
            t.innerHTML = `<div>> ${msg}</div>` + t.innerHTML;
        }

        window.onload = () => { initMap(); initChart(); sync(); setInterval(sync, 15000); };
    </script>
</body>
</html>
