<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIX EYES | AUTO-DEFENDER v9.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00d9ff; --bg: #020202; --panel: #0a0a0c; --java: #00ff41; --danger: #ff003c; }
        body { background: var(--bg); color: var(--neon); font-family: 'JetBrains Mono', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 320px; background: var(--panel); border-right: 1px solid #1a1a1a; padding: 20px; display: flex; flex-direction: column; }
        #terminal { flex: 1; background: #000; padding: 10px; font-size: 11px; color: var(--java); overflow-y: auto; border-left: 2px solid var(--java); margin: 15px 0; }
        
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--panel); padding: 20px; border: 1px solid #1a1a1a; text-align: center; }
        
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .card { background: #0d0d0f; border: 1px solid #1a1a1a; padding: 15px; position: relative; }
        .card.is-bot { border-color: var(--danger); }
        
        .btn { background: none; border: 1px solid var(--neon); color: var(--neon); padding: 10px; cursor: pointer; width: 100%; margin-top: 10px; font-family: inherit; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .status-tag { font-size: 9px; padding: 2px 5px; border-radius: 3px; background: #222; margin-bottom: 5px; display: inline-block; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color: #fff; margin: 0;">üåÄ SIX EYES</h2>
        <div id="defense-status" style="font-size: 10px; color: var(--java);">AUTO-DEFENSE: ACTIVE</div>
        
        <div id="terminal"></div>

        <button class="btn" onclick="sync()">DATABASE REFRESH</button>
        <button class="btn btn-danger" onclick="massPurge()">CLEAR ALL RECORDS</button>
    </aside>

    <main class="main">
        <div class="stats">
            <div class="stat-card"><label style="font-size: 10px; color: #444;">DATABASE LOAD</label><div id="s-total" style="font-size: 24px;">0</div></div>
            <div class="stat-card"><label style="font-size: 10px; color: #444;">AFK ACTIONS</label><div id="s-actions" style="font-size: 24px; color: var(--java);">0</div></div>
            <div class="stat-card"><label style="font-size: 10px; color: #444;">INTEGRITY</label><div id="s-integrity" style="font-size: 24px;">100%</div></div>
        </div>

        <div class="data-grid" id="display"></div>
    </main>

    <script>
        const SUPABASE_URL = 'https://kisbfmcxvcwtxfwbgexb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_THarexbaf5WB2Cc-c6t-sg_TQJycbtz';
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Oq ro'yxat (Sizning IP-laringiz)
        const WHITELIST = ['91.211.134.16', '94.230.231.77', '2a0c:4d00:2:8::2'];
        let afkActionCount = 0;

        function log(msg, type = 'info') {
            const t = document.getElementById('terminal');
            const color = type === 'danger' ? 'var(--danger)' : (type === 'warn' ? '#ffcc00' : 'var(--java)');
            t.innerHTML += `<div style="color:${color}">> [${new Date().toLocaleTimeString()}] ${msg}</div>`;
            t.scrollTop = t.scrollHeight;
        }

        async function sync() {
            const { data, error } = await _supabase.from('telemetry').select('*').order('created_at', { ascending: false });

            if (error) {
                log("Ulanishda xato: " + error.message, 'danger');
                return;
            }

            // AFK DEFENDER LOGIC
            const ipCounts = {};
            data.forEach(n => ipCounts[n.ip] = (ipCounts[n.ip] || 0) + 1);

            for (const ip in ipCounts) {
                // Agar bir IP dan 10 tadan ko'p so'rov bo'lsa va u WHITELIST da bo'lmasa
                if (ipCounts[ip] > 10 && !WHITELIST.includes(ip)) {
                    log(`AFK PROTECTION: Auto-purging Spammer IP ${ip}`, 'warn');
                    await _supabase.from('telemetry').delete().eq('ip', ip);
                    afkActionCount++;
                    document.getElementById('s-actions').innerText = afkActionCount;
                    return sync(); // Tozalagandan keyin qayta yangilash
                }
            }

            updateStats(data);
            render(data);
        }

        function updateStats(data) {
            const threats = data.filter(n => !WHITELIST.includes(n.ip)).length;
            const integrity = data.length > 0 ? Math.round(((data.length - threats) / data.length) * 100) : 100;
            
            document.getElementById('s-total').innerText = data.length;
            document.getElementById('s-integrity').innerText = integrity + "%";
            document.getElementById('s-integrity').style.color = integrity < 70 ? 'var(--danger)' : 'var(--java)';
        }

        function render(nodes) {
            const d = document.getElementById('display');
            d.innerHTML = '';
            nodes.forEach(n => {
                const isWhite = WHITELIST.includes(n.ip);
                d.innerHTML += `
                    <div class="card ${!isWhite ? 'is-bot' : ''}">
                        <div class="status-tag">${isWhite ? 'AUTHORIZED' : 'UNIDENTIFIED'}</div>
                        <div style="font-weight:bold; font-size:16px;">${n.ip}</div>
                        <div style="font-size:11px; color:#555; margin: 5px 0;">üìç ${n.location}</div>
                        <div style="font-size:10px; color:var(--neon);">üïí ${new Date(n.created_at).toLocaleString()}</div>
                        <button class="btn btn-danger" style="font-size:9px; padding:5px; margin-top:10px;" onclick="purgeSingle('${n.id}')">PURGE</button>
                    </div>`;
            });
        }

        async function purgeSingle(id) {
            await _supabase.from('telemetry').delete().eq('id', id);
            sync();
        }

        async function massPurge() {
            if(!confirm("Barcha ma'lumotlarni tozalashga rozimisiz?")) return;
            await _supabase.from('telemetry').delete().neq('id', '00000000-0000-0000-0000-000000000000');
            log("Database fully purged.", 'warn');
            sync();
        }

        // 15 soniyada avtomat yangilash va AFK himoya
        setInterval(sync, 15000);
        window.onload = () => { log("Six Eyes AFK Defense Online."); sync(); };
    </script>
</body>
</html>
